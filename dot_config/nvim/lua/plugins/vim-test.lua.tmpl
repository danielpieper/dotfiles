local map = require("utils").map

map('n', '<Leader>tt', ':TestNearest<CR>', {silent = true})
map('n', '<Leader>tf', ':TestFile<CR>', {silent = true})
map('n', '<Leader>ts', ':TestSuite<CR>', {silent = true})
map('n', '<Leader>tl', ':TestLast<CR>', {silent = true})
map('n', '<Leader><Leader>tt', ':TestNearest -strategy=dispatch<CR>', {silent = true})
map('n', '<Leader><Leader>tf', ':TestFile -strategy=dispatch<CR>', {silent = true})
map('n', '<Leader><Leader>ts', ':TestSuite -strategy=dispatch<CR>', {silent = true})
map('n', '<Leader><Leader>tl', ':TestLast -strategy=dispatch<CR>', {silent = true})
map('n', '<Leader>tv', ':TestVisit<CR>', {silent = true})

{{- if eq .usage "work" }}
vim.api.nvim_command([[
function! PersonioTransform(cmd) abort
  let pod = system('kubectl get pods --context=minikube --selector="app.kubernetes.io/name=web" -o go-template --template "{{`{{\$item := index .items 0}}{{\$item.metadata.name}}`}}"')
  return 'kubectl exec '.pod.' --context=minikube -c fpm -- '.a:cmd
endfunction
]])

vim.api.nvim_command([[let g:test#custom_transformations = {'personio': function('PersonioTransform')}]]);

vim.api.nvim_set_var('test#transformation', 'personio')
vim.api.nvim_set_var('test#php#phpunit#executable', 'vendor/bin/phpunit')
vim.api.nvim_set_var('test#php#phpunit#options', '--testdox')
{{- end }}

-- make test commands execute using dispatch.vim
vim.api.nvim_set_var('test#strategy', 'dispatch_background')
